# CLAMM V3 区间做市 & IL 模拟器 — 功能说明书 🚀

> 只描述**功能**与**计算逻辑**；不涉及部署与代码结构。  
> 工具名称：**CLAMM V3 区间做市 & IL 模拟器**（离线增强版，纯原生 JS + SVG）

---

## 1) 核心功能一览 🧭

- **区间做市模拟（Uniswap v3 / CLAMM）**：输入区间 `[a, b]`、当前价格 `P`，自动按 v3 理论推导投入比例并铸造 `Liquidity`。  
- **两种投入方式**：
  - **自动拆分**：给定总资金 `V`（以报价币，如 USDC 计），在 `P ∈ (a,b)` 时自动分配两边资产；若 `P` 在区间外，按常见做法进行“等值换算”后只注入能生效的一侧。
  - **自定义投入**：手动输入两种代币数量（如 ETH/USDC）。超出区间导致无法入池的资产将**显示为“闲置”**并参与价值比较。
- **情景评估**：设置 `p_f`（未来价格）、`天数`、`手续费年化 APR`、`活跃时间占比`，即时输出 **LP vs HODL** 表现、**IL%**、**含费差** 与 **保本所需年化**。
- **可视化曲线**：展示 `0.2×P → 5×P` 区间的 **IL 曲线（不含费）** 与 **含费超额（LP 相对 HODL）**，并以竖线标出 `P₀`/`a`/`b`。
- **资金利用率**：明确显示进入 LP 的有效金额、闲置资产与**使用率**（%）。
- **多语言**：中 / 英双语切换（🌐 图标）。
- **关注与分享**：右上角支持 **关注作者**（弹窗）与 **一键复制分享链接**（将当前参数编码到 URL）。
- **预设示例**：一键切换 **窄区间** / **宽区间**，便于快速对比。

---

## 2) 页面模块与指标 📊

### 2.1 基础参数
- **当前价格 `P`**（报价：`USDC/ETH`）。
- **价格下界 `a`**、**价格上界 `b`**（工具会自动规范化，确保 `a ≤ b`）。
- **总资金 `V`（以报价币计）**（仅自动模式需要）。
- **投入方式**：`自动拆分` / `自定义投入（ETH 数量 / USDC 数量）`。

> 🧩 自定义模式下，按照 v3 规则从两种代币中 **最大化铸造** `L`，剩余不可用资产记为**闲置**。

### 2.2 情景假设
- **未来价格 `p_f`**（用于点估场景对比）。
- **持有天数**（用于费用估算 / 保本年化）。
- **手续费年化 `APR`**（%）。
- **活跃时间占比**（`0~100%`，估算在区间内的有效时间）。

> 💡 费用采用简化公式：`fees = fee_base × APR × 天数 / 365 × 活跃占比`，其中 `fee_base` 为**进入 LP 的有效金额**（而非全部投入）。

### 2.3 结果概览
- **初始数量（两资产）**、**铸造的 Liquidity `L`**、**区间宽度 `b/a`**。

### 2.4 收益拆解（@ `p_f`）
- **HODL 价值**：将初始两资产在 `p_f` 估值。  
- **LP 价值（不含费）**：在 `p_f` 下 LP 中两侧资产合计价值（若有闲置，亦计入）。  
- **Impermanent Loss（IL%）**：`LP_不含费 / HODL - 1`。  
- **预估手续费收入**：基于 `fee_base` 的简化测算。  
- **LP 含费总价值**：`LP_不含费 + 费用`。  
- **LP 相对 HODL 的超额/劣势**：`LP_含费 / HODL - 1`。  
- **保本所需年化**：`reqAPR = max(0, HODL - LP_不含费) / fee_base × 365 / 天数`。

> ✅ 数值采用颜色提示：正向 **绿色**、负向 **红色**。

### 2.5 区间状态
- **是否在区间内**（`a ≤ p_f ≤ b`）。  
- **当前数量（两资产）**：基于 `L` 与 `p_f` 的解析式计算 **LP 内资产**，再叠加**闲置**。

### 2.6 IL 曲线 & 含费超额（曲线图）
- 横轴：价格（`0.2×P → 5×P`）。  
- 纵轴：百分比（`IL%` 与 `LP 相对 HODL（含费）%`）。  
- 竖线：`P₀`（灰）/ `a`（绿）/ `b`（红）。  
- **任意参数变化**都会**实时刷新**曲线。

### 2.7 LP 使用率 & 闲置
- **初始投入价值**（以报价币计）。  
- **进入 LP 的价值**（有效金额）。  
- **资金使用率（%）**：`有效金额 / 初始投入价值`。  
- **闲置资产**：`ETH / USDC` 的剩余数量。

### 2.8 快速示例与辅助
- **窄区间示例**、**宽区间示例**。  
- **语言切换**（🌐）。  
- **关注我**（⭐ 按钮，弹窗含链接与复制）。  
- **复制分享链接**（🔗 按钮，将当前参数编码进 `URL#hash`）。

---

## 3) 计算逻辑（简要）📐

> 价格均以 `token1 / token0`（示例：`USDC/ETH`）计。  
> 记 `√x` 为 `x` 的平方根。

### 3.1 铸造 Liquidity（核心）
- **区间内** `P ∈ (a, b)`：
  - 解析比例：`r = (√P - √a) / (1/√P - 1/√b)`（单位：`token1 / token0`）。  
  - 自动模式下：从 `V` 推导 `amount0` 与 `amount1`，使两侧 `L` 相等：  
    - `L₀ = amount0 / (1/√P - 1/√b)`  
    - `L₁ = amount1 / (√P - √a)`  
    - `L = min(L₀, L₁)`  
  - 自定义模式下：由输入的 `c0`、`c1` 计算：  
    - `L₀ = c0 / (1/√P - 1/√b)`，`L₁ = c1 / (√P - √a)`  
    - `L = min(L₀, L₁)`；超出部分记为**闲置**。

- **区间外**：
  - `P ≤ a`：只有 `token0` 生效，`L = amount0 / (1/√a - 1/√b)`；`token1` 视为闲置（自定义模式）。  
  - `P ≥ b`：只有 `token1` 生效，`L = amount1 / (√b - √a)`；`token0` 视为闲置（自定义模式）。  
  - 自动模式下，若 `P` 在区间外，会将 `V` 视作“在 `P` 处等值换算”为可入池的一侧，便于比较。

### 3.2 任意价格下的资产数量（LP 内）
- `p ≤ a`：`token0 = L×(1/√a - 1/√b)`，`token1 = 0`。  
- `p ≥ b`：`token0 = 0`，`token1 = L×(√b - √a)`。  
- `a < p < b`：
  - `token0(p) = L×(1/√p - 1/√b)`  
  - `token1(p) = L×(√p - √a)`

> **当前数量** = **LP 内数量** + **闲置数量**。

### 3.3 估值、IL 与费用
- **LP 价值（不含费）**：`token0(p)×p + token1(p) + idle0×p + idle1`。  
- **HODL 价值**：`amount0_init×p + amount1_init`。  
- **IL%**：`LP_不含费 / HODL - 1`。  
- **费用（简化）**：`fees = fee_base × APR × 天数/365 × 活跃占比`；`fee_base = 进入 LP 的有效金额`。  
- **LP 含费价值**：`LP_不含费 + fees`。  
- **相对优势**：`(LP_含费 / HODL - 1)`。  
- **保本所需年化**：`reqAPR = max(0, HODL - LP_不含费) / fee_base × 365 / 天数`。

### 3.4 曲线
- 价格范围：`pf ∈ [0.2×P, 5×P]`（等距采样）。  
- 输出：`IL%` 与 `LP 相对 HODL（含费）%` 两条曲线；随参数即时刷新。

---

## 4) 交互细节与体验 ✨

- **自动格式化**：数值按千分位与小数位显示。  
- **提示色**：收益类指标正/负分别用绿色/红色强调。  
- **输入容错**：若误填 `a > b`，自动互换保证 `a ≤ b`。  
- **示例按钮**：快速切换“窄 / 宽区间”，对比形态。  
- **语言**：右上角 🌐 一键切换中/英。  
- **关注我**：点击 ⭐ 弹出关注窗口（含 X/Twitter 链接与复制）。  
- **分享参数**：点击 🔗 将当前参数编码到 `URL#hash`，一键复制。

---

## 5) 模型假设与限制 ⚠️

- **费用为简化估算**：未模拟交易量/TVL 动态、不同费档（0.01/0.05/0.3/1%）差异、复利与再投资。  
- **无滑点/冲击**：忽略做市价格冲击、Gas、再平衡成本与税费。  
- **忽略 Tick 颗粒度**：区间连续近似，未对齐具体 Tick。  
- **外部数据未接入**：离线版不依赖行情 / 指数数据源。  
- **教育用途**：仅用于策略理解与区间设计的**对比参考**，不构成投资建议。

---

## 6) 术语小字典 📚

- **`P`**：当前价格（报价：`token1/token0`，如 `USDC/ETH`）。  
- **`a, b`**：做市区间下界/上界（`a < b`）。  
- **`V`**：总资金（以报价币计）。  
- **`L`**：v3「集中流动性」的流动性规模。  
- **`p_f`**：未来评估价格。  
- **`APR`**：手续费年化假设。  
- **`活跃时间占比`**：预估在区间内的时间权重。  
- **`IL%`**：无常损益（相对 HODL）。  
- **`保本所需年化`**：在给定天数与活跃占比下，使 LP（含费）与 HODL 持平的最低年化费率。

---

## 7) 典型用法示例 🧪

- 观察 **区间宽度**对 IL 曲线的影响：试试「窄区间」与「宽区间」按钮。  
- 切到**自定义投入**，模拟“只有 ETH/只有 USDC/两者混合”进入 LP 的情形，关注“**使用率**”与**闲置**变化。  
- 在波动更剧烈的场景中，提升 `APR` 与 `活跃占比`，对比 **保本所需年化** 是否合理。

---

**Enjoy LPing!** 🦄  
作者：@MengLayer ｜ 欢迎反馈需求与改进点。
